#!/bin/bash
# luma3ds

# Define directories
dir_luma3ds=~/Documents/3ds/luma3ds
dir_src=~/src
dir_out=$dir_src/out
dir_build=$dir_src/build
dir_luma=$dir_out/luma
dir_system=$dir_luma/system
dir_payloads=$dir_luma/payloads
dir_locales=~/Documents/3ds/locales
dir_cia=$dir_luma/cia
dir_cia_apps=$dir_cia/apps
dir_cia_games=$dir_cia/games
dir_cia_updates=$dir_cia/updates
dir_tmp=$dir_system/tmp

# Dependencies
dir_a9lh=~/Documents/3ds/a9lh_files
dir_decrypt9wip_files=~/Documents/3ds/decrypt9wip_files
dir_cia_files=~/Documents/3ds/cia_files
dir_misc_files=~/Documents/3ds/misc_files
dir_filer=~/Documents/3ds/filer

# Luma3DS Menu
echo "";
echo "**** Luma3DS Menu ****";
echo "[1] Build CFW";
echo "[2] Update repository";
echo -n "Select your choice: ";
read choice;

case $choice in
	1)
	# Clean src directory
	rm -rf $dir_build $dir_out $dir_src/sdmc*;
	mkdir -vp $dir_build $dir_out $dir_luma $dir_system;
	mkdir -vp $dir_cia $dir_cia_apps $dir_cia_games $dir_cia_updates $dir_tmp; 
	cp -rR $dir_luma3ds/* $dir_build/;
	
	# Luma3DS
	cd $dir_build/Luma3DS;
	make clean;
	sed -i -e 's|filepath ?=|filepath ?= luma/system/Luma3DS/|g' $dir_build/Luma3DS/CakeBrah/Makefile;
	sed -i -e 's|filepath ?=|filepath ?= luma/system/Luma3DS/|g' $dir_build/Luma3DS/CakeHax/Makefile;
	cd $dir_build/Luma3DS;
	make;
	mv -v $dir_build/Luma3DS/out/luma/* $dir_out/luma/;
	cp -v $dir_build/Luma3DS/out/arm9loaderhax.bin $dir_payloads/boot.bin;
	mkdir -vp $dir_system/Luma3DS;
	mv -v $dir_build/Luma3DS/out/3ds/Luma3DS/* $dir_system/Luma3DS/;
	mv -v $dir_build/Luma3DS/out/Luma3DS.dat $dir_system/Luma3DS/;
	
	# Arm9loaderhax
	cd $dir_build/arm9loaderhax;
	make clean;
	cd $dir_build/arm9loaderhax/payload_stage2/source;
	sed -i -e 's|"arm9loaderhax.bin"|"/luma/payloads/boot.bin"|g' main.c
	cd $dir_build/arm9loaderhax;
	make;
	
	# SafeA9LHInstaller - n3ds
	cd $dir_build/SafeA9LHInstaller;
	make clean;
	cd $dir_build/SafeA9LHInstaller/source/;
	sed -i -e 's|"a9lh/otp.bin"|"luma/system/SafeA9LHInstaller-n3ds/otp.bin"|g' installer.c
	sed -i -e 's|"a9lh/secret_sector.bin"|"luma/system/SafeA9LHInstaller-n3ds/secret_sector.bin"|g' installer.c
	sed -i -e 's|"a9lh/firm0.bin"|"luma/system/SafeA9LHInstaller-n3ds/firm0.bin"|g' installer.c
	sed -i -e 's|"a9lh/firm1.bin"|"luma/system/SafeA9LHInstaller-n3ds/firm1.bin"|g' installer.c
	sed -i -e 's|"a9lh/payload_stage1.bin"|"luma/system/SafeA9LHInstaller-n3ds/payload_stage1.bin"|g' installer.c
	sed -i -e 's|"a9lh/payload_stage2.bin"|"luma/system/SafeA9LHInstaller-n3ds/payload_stage2.bin"|g' installer.c
	cd $dir_build/SafeA9LHInstaller/CakeBrah/;
	sed -i -e 's|filepath ?=|filepath ?= luma/system/SafeA9LHInstaller-n3ds/|g' Makefile;
	cd $dir_build/SafeA9LHInstaller/CakeHax/;
	sed -i -e 's|filepath ?=|filepath ?= luma/system/SafeA9LHInstaller-n3ds/|g' Makefile;
	cd $dir_build/SafeA9LHInstaller;
	make;
	mv -v $dir_build/SafeA9LHInstaller/out/arm9loaderhax.bin $dir_payloads/x_safea9lhinstaller-n3ds-v$(date +%Y%m%d).bin;
	mkdir -v $dir_system/SafeA9LHInstaller-n3ds;
	mv -v $dir_build/SafeA9LHInstaller/out/3ds/SafeA9LHInstaller/* $dir_system/SafeA9LHInstaller-n3ds/;
	mv -v $dir_build/SafeA9LHInstaller/out/SafeA9LHInstaller.dat $dir_system/SafeA9LHInstaller-n3ds/;
	cp -v $dir_build/arm9loaderhax/out/* $dir_system/SafeA9LHInstaller-n3ds/;
	cp -v $dir_a9lh/n3ds/* $dir_system/SafeA9LHInstaller-n3ds/;
	
	# SafeA9LHInstaller - n3ds
	rm -rf $dir_build/SafeA9LHInstaller; cp -rR $dir_luma3ds/SafeA9LHInstaller $dir_build/;
	cd $dir_build/SafeA9LHInstaller;
	make clean;
	cd $dir_build/SafeA9LHInstaller/source/;
	sed -i -e 's|"a9lh/otp.bin"|"luma/system/SafeA9LHInstaller-o3ds/otp.bin"|g' installer.c
	sed -i -e 's|"a9lh/secret_sector.bin"|"luma/system/SafeA9LHInstaller-o3ds/secret_sector.bin"|g' installer.c
	sed -i -e 's|"a9lh/firm0.bin"|"luma/system/SafeA9LHInstaller-o3ds/firm0.bin"|g' installer.c
	sed -i -e 's|"a9lh/firm1.bin"|"luma/system/SafeA9LHInstaller-o3ds/firm1.bin"|g' installer.c
	sed -i -e 's|"a9lh/payload_stage1.bin"|"luma/system/SafeA9LHInstaller-o3ds/payload_stage1.bin"|g' installer.c
	sed -i -e 's|"a9lh/payload_stage2.bin"|"luma/system/SafeA9LHInstaller-o3ds/payload_stage2.bin"|g' installer.c
	cd $dir_build/SafeA9LHInstaller/CakeBrah/;
	sed -i -e 's|filepath ?=|filepath ?= luma/system/SafeA9LHInstaller-o3ds/|g' Makefile;
	cd $dir_build/SafeA9LHInstaller/CakeHax/;
	sed -i -e 's|filepath ?=|filepath ?= luma/system/SafeA9LHInstaller-o3ds/|g' Makefile;
	cd $dir_build/SafeA9LHInstaller;
	make;
	mv -v $dir_build/SafeA9LHInstaller/out/arm9loaderhax.bin $dir_payloads/x_safea9lhinstaller-o3ds-v$(date +%Y%m%d).bin;
	mkdir -v $dir_system/SafeA9LHInstaller-o3ds;
	mv -v $dir_build/SafeA9LHInstaller/out/3ds/SafeA9LHInstaller/* $dir_system/SafeA9LHInstaller-o3ds/;
	mv -v $dir_build/SafeA9LHInstaller/out/SafeA9LHInstaller.dat $dir_system/SafeA9LHInstaller-o3ds/;
	cp -v $dir_build/arm9loaderhax/out/* $dir_system/SafeA9LHInstaller-o3ds/;
	cp -v $dir_a9lh/o3ds/* $dir_system/SafeA9LHInstaller-o3ds/;
	
  	# Decrypt9WIP
	cd $dir_build/Decrypt9WIP;
	make clean;
	cd $dir_build/Decrypt9WIP/source/decryptor;
	sed -i -e 's|"aeskeydb.bin"|"/luma/system/aeskeydb.bin"|g' keys.c;
	cd $dir_build/Decrypt9WIP;
	make;
	mv -v $dir_build/Decrypt9WIP/output/Decrypt9WIP.bin $dir_payloads/up_decrypt9-v$(date +%Y%m%d).bin;
	cp -v $dir_decrypt9wip_files/aeskeydb.bin $dir_system/;

	# EmuNAND9
	cd $dir_build/EmuNAND9;
	make clean;
	cd $dir_build/EmuNAND9/source;
	cd $dir_build/EmuNAND9;
	make;
	mv -v $dir_build/EmuNAND9/output/EmuNAND9.bin $dir_payloads/right_emunand9-v$(date +%Y%m%d).bin;

	# Godmode9
	cd $dir_build/GodMode9;
	make clean;
	make;
	mv -v $dir_build/GodMode9/output/GodMode9.bin $dir_payloads/left_godmode9-v$(date +%Y%m%d).bin;

	# Uncart
	cd $dir_build/uncart;
	make clean;
	make;
	mv -v $dir_build/uncart/arm9loaderhax.bin $dir_payloads/down_uncart-v$(date +%Y%m%d).bin;
  	
  	# FBI
	cd $dir_build/FBI;
	make clean;
	make;
	cp -v $dir_build/FBI/output/FBI.cia $dir_cia_apps/fbi-v$(date +%Y%m%d).cia;

	# ftpd
	cd $dir_build/ftpd;
	make clean;
	make;
	cp -v $dir_build/ftpd/output/ftpd.cia $dir_cia_apps/ftpd-v$(date +%Y%m%d).cia;
	
	# Copy depencencies
	cp -rR $dir_locales $dir_luma/;
	cp -v $dir_cia_files/apps/*.cia $dir_cia_apps/;
	cp -v $dir_misc_files/boot.3dsx $dir_out;
	cp -rR $dir_filer $dir_out/;
	mkdir -vp $dir_tmp/db; touch $dir_tmp/db/title.db $dir_tmp/db/import.db;
	cp -rR $dir_decrypt9wip_files/n3ds $dir_tmp/hs-n3ds; cp -rR $dir_decrypt9wip_files/o3ds $dir_tmp/hs-o3ds;

	# Cleanup
	cd ~/src;
	#rm -rf $dir_build;
	mv -v $dir_out luma3ds-v$(date +%Y%m%d);
	echo "";
	echo "Build finished!";
	;;
	
	2)
    	mkdir -vp $dir_luma3ds; rm -rf $dir_luma3ds; mkdir -vp $dir_luma3ds;
    	cd $dir_luma3ds;
    	echo "";
    	echo "Fetching Homebrew...";
    	git clone --recursive https://github.com/AuroraWright/Luma3DS.git;
    	git clone --recursive -b noscreeninit https://github.com/AuroraWright/arm9loaderhax.git
    	git clone --recursive https://github.com/AuroraWright/SafeA9LHInstaller.git
    	git clone --recursive https://github.com/d0k3/Decrypt9WIP.git;
    	git clone --recursive https://github.com/d0k3/EmuNAND9.git;
    	git clone --recursive https://github.com/d0k3/GodMode9.git;
    	git clone --recursive https://github.com/AuroraWright/uncart.git
    	git clone --recursive https://github.com/Steveice10/FBI.git;
    	git clone --recursive https://github.com/3xkrazy/ftpd.git;
    	echo "";
    	echo "Repository updated!";
    	echo "";
    	
    	exit 0;
    	;;
	
  	*)
    	echo "";
    	echo "You selected an invalid choice!";
    	
    	exit 1;
    	;;
esac
