#!/bin/bash
# build3ds

# NATIVE_FIRM
n3ds_firm=http://nus.cdn.c.shop.nintendowifi.net/ccs/download/0004013820000002/0000001B
n3ds_cetk=http://nus.cdn.c.shop.nintendowifi.net/ccs/download/0004013820000002/cetk
o3ds_firm=http://nus.cdn.c.shop.nintendowifi.net/ccs/download/0004013800000002/00000049
o3ds_cetk=http://nus.cdn.c.shop.nintendowifi.net/ccs/download/0004013800000002/cetk
#n3ds_firm=http://nus.cdn.c.shop.nintendowifi.net/ccs/download/0004013820000002/0000001F
#n3ds_cetk=http://nus.cdn.c.shop.nintendowifi.net/ccs/download/0004013820000002/cetk
#o3ds_firm=http://nus.cdn.c.shop.nintendowifi.net/ccs/download/0004013800000002/00000050
#o3ds_cetk=http://nus.cdn.c.shop.nintendowifi.net/ccs/download/0004013800000002/cetk

# TWL_FIRM
n3ds_twl_firm=http://nus.cdn.c.shop.nintendowifi.net/ccs/download/0004013820000102/00000000
n3ds_twl_cetk=http://nus.cdn.c.shop.nintendowifi.net/ccs/download/0004013820000102/cetk
o3ds_twl_firm=http://nus.cdn.c.shop.nintendowifi.net/ccs/download/0004013800000102/00000016
o3ds_twl_cetk=http://nus.cdn.c.shop.nintendowifi.net/ccs/download/0004013800000102/cetk

# AGB_FIRM
n3ds_agb_firm=http://nus.cdn.c.shop.nintendowifi.net/ccs/download/0004013820000202/00000000
n3ds_agb_cetk=http://nus.cdn.c.shop.nintendowifi.net/ccs/download/0004013820000202/cetk
o3ds_agb_firm=http://nus.cdn.c.shop.nintendowifi.net/ccs/download/0004013800000202/0000000B
o3ds_agb_cetk=http://nus.cdn.c.shop.nintendowifi.net/ccs/download/0004013800000202/cetk

# BootNTR url
ntr=https://github.com/44670/BootNTR/releases/download/3.2/NTR.3.2.zip

# Dependencies
dir_a9lh_files=~/Documents/3ds/a9lh_files
dir_cakesfw_files=~/Documents/3ds/cakesfw_files
dir_cia_files=~/Documents/3ds/cia_files
dir_decrypt9wip_files=~/Documents/3ds/decrypt9wip_files
dir_slotkeybin_files=~/Documents/3ds/slotkeybin_files
dir_misc=~/Documents/3ds/misc
dir_filer=~/Documents/3ds/filer
dir_plugin=~/Documents/3ds/plugin

# Directories
dir_src=~/src
dir_build=~/src/build
dir_homebrew=~/src/homebrew
dir_out=~/src/out
dir_3ds=~/src/out/3ds
dir_cia=~/src/out/3ds/sys/cia
dir_bin=~/src/out/3ds/sys/bin
dir_firm=~/src/homebrew/firm
dir_twl=~/src/homebrew/twl
dir_agb=~/src/homebrew/agb

# Menu
echo "";
echo "[1] Update homebrew";
echo "[2] Build homebrew";
echo -n "Select your choice: ";
read option;
if [ $option != "1" ] && [ $option != "2" ]; then
  echo "Invalid choice!";
  exit 1;
fi
if [ $option = "1" ]; then 
  # Fetch the homebrew from github
  mkdir -vp $dir_homebrew
  rm -rfv $dir_homebrew/*;
  mkdir -vp $dir_firm/n3ds;
  mkdir -vp $dir_firm/o3ds;
  mkdir -vp $dir_twl/n3ds;
  mkdir -vp $dir_twl/o3ds;
  mkdir -vp $dir_agb/n3ds;
  mkdir -vp $dir_agb/o3ds;
  cd $dir_homebrew;
  echo "Fetching homebrew...";
  git clone --recursive https://github.com/d0k3/Decrypt9WIP.git
  git clone --recursive https://github.com/d0k3/EmuNAND9.git
  git clone --recursive https://github.com/d0k3/GodMode9.git
  git clone --recursive https://github.com/mid-kid/CakesForeveryWan.git
  git clone --recursive https://github.com/Reisyukaku/ReiNand.git
  git clone --recursive https://github.com/delebile/arm9loaderhax.git
  git clone --recursive https://github.com/yellows8/hblauncher_loader.git
  git clone --recursive https://github.com/44670/BootNTR.git
  git clone --recursive -b a9lh https://github.com/Cpasjuste/CtrBootManager.git
  cd $dir_firm/n3ds;
  wget $n3ds_firm;
  wget $n3ds_cetk;
  cd $dir_firm/o3ds;
  wget $o3ds_firm;
  wget $o3ds_cetk;
  cd $dir_twl/n3ds;
  wget $n3ds_twl_firm;
  wget $n3ds_twl_cetk;
  cd $dir_twl/o3ds;
  wget $o3ds_twl_firm;
  wget $o3ds_twl_cetk;
  cd $dir_agb/n3ds;
  wget $n3ds_agb_firm;
  wget $n3ds_agb_cetk;
  cd $dir_agb/o3ds;
  wget $o3ds_agb_firm;
  wget $o3ds_agb_cetk;
  cd $dir_homebrew;
  mkdir ntr_zip;
  cd ntr_zip;
  wget $ntr;
  unzip *.zip;
  echo "Homebrew up to date! Exiting...";
  exit 1;
fi

# Make directories
rm -rfv $dir_build;
rm -rfv $dir_out;
rm -rfv $dir_src/sdmc*;
mkdir -vp $dir_build
mkdir -vp $dir_out
mkdir -vp $dir_3ds
mkdir -vp $dir_cia/apps
mkdir -vp $dir_cia/games
mkdir -vp $dir_cia/updates
mkdir -vp $dir_bin
cp -rRv $dir_homebrew/* $dir_build/;

# Decrypt9WIP
cd $dir_build/Decrypt9WIP;
echo "Building Decrypt9WIP...";
sleep 5s;
make clean;
cd $dir_build/Decrypt9WIP/source/decryptor;
sed -i -e 's|"aeskeydb.bin"|"/3ds/sys/bin/aeskeydb.bin"|g' keys.c;
sed -i -e 's|"slot0x%02X%s.bin"|"/3ds/sys/bin/slot0x%02X%s.bin"|g' keys.c;
cd $dir_build/Decrypt9WIP;
make bootstrap;
mv -v $dir_build/Decrypt9WIP/output/Decrypt9WIP.bin $dir_bin/;
echo "Done!";

# EmuNAND9
cd $dir_build/EmuNAND9;
echo "Building EmuNAND9...";
sleep 5s;
make clean;
make bootstrap;
mv -v $dir_build/EmuNAND9/output/EmuNAND9.bin $dir_bin/;
echo "Done!";

# Godmode9
cd $dir_build/GodMode9;
echo "Building GodMode9...";
sleep 5s;
make clean;
cd $dir_build/GodMode9/source/nand;
#if [ $option = "1" ]; then
#  sed -i -e 's|"%s/aeskeydb.bin", folder|"/3ds/sys/bin/slot0x05KeyY.bin"|g' nand.c;
#  sed -i -e 's|"%s/slot0x%02XKey%.10s", folder|"/3ds/sys/bin/slot0x%02XKey%.10s"|g' nand.c;
#fi
cd $dir_build/GodMode9;
make bootstrap;
mv -v $dir_build/GodMode9/output/GodMode9.bin $dir_bin/;
echo "Done!";

# CakesFW
cd $dir_build/CakesForeveryWan;
echo "Building CakesForeveryWan...";
sleep 5s;
make clean;
cd $dir_build/CakesForeveryWan/source;
sed -i -e 's|"/cakes"|"/3ds/Cakes/cakes"|g' paths.h;
sed -i -e '7i#define PATH_BIN "/3ds/sys/bin"\' paths.h;
sed -i -e 's|#define PATH_SLOT0X25KEYX "/slot0x25keyX.bin"|#define PATH_SLOT0X25KEYX PATH_BIN "/slot0x25keyX.bin"|g' paths.h;
sed -i -e 's|#define PATH_SLOT0X11KEY96 "/slot0x11key96.bin"|#define PATH_SLOT0X11KEY96 PATH_BIN "/slot0x11key96.bin"|g' paths.h;
cd $dir_build/CakesForeveryWan/CakeBrah/;
sed -i -e 's|filepath ?=|filepath ?= 3ds/Cakes/cakes/|g' Makefile;
cd $dir_build/CakesForeveryWan/CakeHax/;
sed -i -e 's|filepath ?=|filepath ?= 3ds/Cakes/cakes/|g' Makefile;
cd $dir_build/CakesForeveryWan/;
make;
mv -v $dir_build/CakesForeveryWan/out/Cakes.dat $dir_build/CakesForeveryWan/out/cakes/;
cp -v $dir_build/CakesForeveryWan/build/main.bin $dir_build/CakesForeveryWan/out/cakes/arm9loaderhax.bin;
mv -v $dir_build/CakesForeveryWan/out/cakes $dir_build/CakesForeveryWan/out/3ds/Cakes/;
cd $dir_build/CakesForeveryWan/out/3ds/Cakes/cakes;
cp -rRv $dir_build/CakesForeveryWan/out/3ds/Cakes $dir_3ds/Cakes-n3ds;
cp -rRv $dir_build/CakesForeveryWan/out/3ds/Cakes $dir_3ds/Cakes-o3ds;
cd $dir_3ds/Cakes-n3ds/cakes;
wget $n3ds_twl_firm;
wget $n3ds_twl_cetk;
mv -v $dir_3ds/Cakes-n3ds/cakes/000000* $dir_3ds/Cakes-n3ds/cakes/twl_firmware.bin
mv -v $dir_3ds/Cakes-n3ds/cakes/cetk $dir_3ds/Cakes-n3ds/cakes/twl_cetk;
wget $n3ds_agb_firm;
wget $n3ds_agb_cetk;
mv -v $dir_3ds/Cakes-n3ds/cakes/000000* $dir_3ds/Cakes-n3ds/cakes/agb_firmware.bin
mv -v $dir_3ds/Cakes-n3ds/cakes/cetk $dir_3ds/Cakes-n3ds/cakes/agb_cetk;
wget $n3ds_cetk;
wget $n3ds_firm;
mv -v $dir_3ds/Cakes-n3ds/cakes/000000* $dir_3ds/Cakes-n3ds/cakes/firmware.bin;
cd $dir_3ds/Cakes-o3ds/cakes;
wget $o3ds_twl_firm;
wget $o3ds_twl_cetk;
mv -v $dir_3ds/Cakes-o3ds/cakes/000000* $dir_3ds/Cakes-o3ds/cakes/twl_firmware.bin
mv -v $dir_3ds/Cakes-o3ds/cakes/cetk $dir_3ds/Cakes-o3ds/cakes/twl_cetk;
wget $o3ds_agb_firm;
wget $o3ds_agb_cetk;
mv -v $dir_3ds/Cakes-o3ds/cakes/000000* $dir_3ds/Cakes-o3ds/cakes/agb_firmware.bin
mv -v $dir_3ds/Cakes-o3ds/cakes/cetk $dir_3ds/Cakes-o3ds/cakes/agb_cetk;
wget $o3ds_cetk;
wget $o3ds_firm;
mv -v $dir_3ds/Cakes-o3ds/cakes/000000* $dir_3ds/Cakes-o3ds/cakes/firmware.bin;
echo "Done!";

# ReiNand
echo "Building ReiNand...";
cd $dir_build/ReiNand;
sleep 5s;
make clean;
cd $dir_build/ReiNand/CakeBrah;
sed -i -e 's|filepath ?=|filepath ?= 3ds/ReiNand/rei/|g' Makefile;
cd $dir_build/ReiNand/CakeHax;
sed -i -e 's|filepath ?=|filepath ?= 3ds/ReiNand/rei/|g' Makefile;
cd $dir_build/ReiNand/source;
sed -i -e 's|"/rei/splash.bin"|"/3ds/ReiNand/rei/splash.bin"|g' draw.c;
sed -i -e 's|"/rei/firmware.bin"|"/3ds/ReiNand/rei/firmware.bin"|g' firm.c;
sed -i -e 's|"/rei/emunand/emunand.bin"|"/3ds/ReiNand/rei/emunand/emunand.bin"|g' firm.c;
sed -i -e 's|"/rei/loader.cxi"|"/3ds/ReiNand/rei/loader.cxi"|g' firm.c;
cd $dir_build/ReiNand;
make;
mv -v $dir_build/ReiNand/out/rei $dir_build/ReiNand/out/3ds/ReiNand/;
mv -v $dir_build/ReiNand/out/arm9loaderhax.bin $dir_build/ReiNand/out/3ds/ReiNand/rei/;
mv -v $dir_build/ReiNand/out/ReiNand.dat $dir_build/ReiNand/out/3ds/ReiNand/rei/;
mv -v $dir_build/ReiNand/out/3ds/ReiNand $dir_3ds/;
echo "Done!";

# Arm9loaderhax n3ds
echo "Building Arm9loaderhax for n3DS...";
sleep 5s;
cd $dir_build/arm9loaderhax;
make clean;
cd $dir_build/arm9loaderhax/payload_stage2/source;
sed -i -e 's|"arm9loaderhax.bin"|"/3ds/sys/bin/arm9loaderhax.bin"|g' main.c;
cd $dir_build/arm9loaderhax/data_input;
cp -v $dir_a9lh_files/new3ds10.firm $dir_build/arm9loaderhax/data_input;
cp -v $dir_a9lh_files/new3ds90.firm $dir_build/arm9loaderhax/data_input;
cp -v $dir_a9lh_files/secret_sector.bin $dir_build/arm9loaderhax/data_input;
cp -v $dir_a9lh_files/otp.bin-n3ds $dir_build/arm9loaderhax/data_input/otp.bin;
cd $dir_build/arm9loaderhax/;
make;
mv -v $dir_build/arm9loaderhax/data_output $dir_3ds/arm9loaderhax-n3ds;
make clean;

# Arm9loaderhax o3ds
echo "Building Arm9loaderhax for o3DS...";
sleep 5s;
cd $dir_build/arm9loaderhax;
cd $dir_build/arm9loaderhax/data_input;
rm $dir_build/arm9loaderhax/data_input/*;
make clean;
cp -v $dir_a9lh_files/new3ds10.firm $dir_build/arm9loaderhax/data_input;
cp -v $dir_a9lh_files/new3ds90.firm $dir_build/arm9loaderhax/data_input;
cp -v $dir_a9lh_files/secret_sector.bin $dir_build/arm9loaderhax/data_input;
cp -v $dir_a9lh_files/otp.bin-o3ds $dir_build/arm9loaderhax/data_input/otp.bin;
cd $dir_build/arm9loaderhax/;
make;
mv -v $dir_build/arm9loaderhax/data_output $dir_3ds/arm9loaderhax-o3ds;
echo "Done!";

# hblauncher_loader
echo "Building hblaunhcer_loader...";
sleep 5s;
cd $dir_build/hblauncher_loader;
make clean;
cd $dir_build/hblauncher_loader/source;
sed -i -e 's|"sdmc:/hblauncherloader_otherapp_payload_%s.bin"|"sdmc:/3ds/sys/bin/hblauncherloader_otherapp_payload_%s.bin"|g' hblauncher_loader.c;
cd $dir_build/hblauncher_loader;
make;
cp -v hblauncher_loader.cia $dir_cia/apps/;
echo "Done!";

# CtrBootManager
echo "Building CtrBootManager";
sleep 5s;
cd $dir_build/CtrBootManager/source;
sed -i -e 's|#define CONFIG_PATH "/a9lh.cfg"|#define CONFIG_PATH "/3ds/sys/bin/a9lh.cfg"|g' config.h;
cd $dir_build/CtrBootManager;
mkdir build;
cd build;
cmake -DCMAKE_TOOLCHAIN_FILE=../DevkitArm3DS.cmake ../
cd $dir_build/CtrBootManager/build/CMakeFiles/CtrBootManager_a9lh.dir;
sed -i -e 's|--set-section-flags|~/.bin/devkitPro/devkitARM/bin/arm-none-eabi-objcopy --set-section-flags|g' build.make;
cd $dir_build/CtrBootManager/build;
cmake --build . --target CtrBootManager_a9lh
cp -v CtrBootManager9.bin $dir_bin/arm9loaderhax.bin;
echo "[general]
timeout = 10
recovery = 2
default = 0

[theme]
bgTop1 = 000000
bgTop2 = 000000
bgBottom = 000000
highlight = 000000
borders = ffffff
font1 = ffffff
font2 = ff0000
bgImgTop = /3ds/sys/bin/bgTop.bin
bgImgBot = /3ds/sys/bin/bgBot.bin

[entry]
title = CakesFW
path =  /3ds/Cakes/cakes/arm9loaderhax.bin
offset = 0
key = -1

title = ReiNand
path =  /3ds/ReiNand/rei/arm9loaderhax.bin
offset = 0
key = -1

[entry]
title = Decrypt9
path =  /3ds/sys/bin/Decrypt9WIP.bin
offset = 0
key = 3

[entry]
title = EmuNAND9
path =  /3ds/sys/bin/EmuNAND9.bin
offset = 0
key = 3

[entry]
title = GodMode9
path =  /3ds/sys/bin/GodMode9.bin
offset = 0
key = 3

[entry]
title = Uncart
path =  /3ds/sys/bin/Uncart-a9lh.bin
offset = 0
key = 3" > $dir_bin/a9lh.cfg;
echo "Done!";

# Build BootNTR and extract ntr.bin
echo "Building BootNTR...";
sleep 5s;
cd $dir_build/BootNTR;
make clean;
cp -v $dir_misc/makerom $dir_build/BootNTR/lib/ctrcommon/tools/makerom-linux;
chmod u+x $dir_build/BootNTR/lib/ctrcommon/tools/*linux;
make;
cp -v $dir_build/BootNTR/output/BootNTR.cia $dir_cia/apps/;
cp -v $dir_build/ntr_zip/ntr.bin $dir_out/;
echo "Done!";

# Copy files over
cp -v $dir_slotkeybin_files/* $dir_bin/;
cp -v $dir_misc/Uncart-a9lh.bin $dir_bin/;
cp -v $dir_cia_files/apps/*.cia $dir_cia/apps/;
cp -v $dir_misc/boot.3dsx $dir_out;
cp -rRv $dir_filer $dir_out/;
cp -rRv $dir_plugin $dir_out/;

# Clean up
cd ~/src;
mv -v $dir_out sdmc_root-$(date +%m-%d-%Y);
exit 0;
